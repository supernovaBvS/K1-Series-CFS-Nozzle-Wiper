[gcode_macro CFS_NOZZLE_CLEAR]
description: Optimized nozzle wipe for K1 Series with CFS Purge Chute
gcode:
    M118 ====== CFS_NOZZLE_CLEAR START ======
    # Homing check
    {% if "xyz" not in printer.toolhead.homed_axes %}
        M118 Printer not homed. Homing now...
        G28
    {% endif %}

    # Variables
    {% set WIPES = params.WIPES|default(8)|int %}
    {% set WIDTH = params.WIDTH|default(13)|float %} # Total sweep distance
    # For percision wipe, you must fine tune the center of the wiper and update the value of CENTRE_X and CENTRE_Y.
    {% set CENTRE_X = 167.0 %}
    {% set CENTRE_Y = 226 %}
    {% set LEFT_X = CENTRE_X - (WIDTH / 2) %}
    {% set RIGHT_X = CENTRE_X + (WIDTH / 2) %}
    {% set current_z = printer.toolhead.position.z %}
    {% set CLEARANCE = 10 %}
    {% set MIN_SAFE_Z = 30 %}
    {% set MAX_Z = 250 %}
    
    # Calculate target Z: max of (current+clearance, minimum safe)
    {% set target_z = [current_z + CLEARANCE, MIN_SAFE_Z]|max %}
    {% if target_z > MAX_Z %}
        {% set target_z = MAX_Z %}
    {% endif %}

    M118 Preparing nozzle cleaning (Wipes: {WIPES})
    M118 Safe Vertical Move
    G90
    G0 Z{target_z} F600
    M400

    # Move to wiper position (toolhead goes to back)
    M118 Scrubbing from X={CENTRE_X}, Y={CENTRE_Y}
    G0 X{CENTRE_X} Y{CENTRE_Y} F3000
    M400

    M118 Scrubbing...
    {% for _ in range(WIPES) %}
        G0 X{LEFT_X} F4000
        G0 X{RIGHT_X} F4000
    {% endfor %}
    M400

    M118 Returning to safe position
    M118 Nozzle clean complete.
    BOX_MOVE_TO_SAFE_POS
    M400
    M118 === CFS_NOZZLE_CLEAR COMPLETE ===

[gcode_macro CX_NOZZLE_CLEAR]
rename_existing: cx_nozzle_clear_py
description: Override to replace Creality Print Firmware Nozzle Clear Program.
gcode:
  CFS_NOZZLE_CLEAR
  {action_respond_info("This is updated CX_NOZZLE_CLEAR")}
